const express=require("express");const{Server}=require("socket.io");const{createServer}=require("node:http");const mongoose=require("mongoose");const app=express();const server=createServer(app);var a=9999999;const io=new Server(server,{connectionStateRecovery:{}});app.use(express.static(__dirname));const Message=require("./model/message");const User=require("./model/user");const readline=require("readline");const rl=readline.createInterface({input:process.stdin,output:process.stdout});rl.question("Nhập mật khẩu để chạy server: ",password=>{console.log(`Mật khẩu không đúng`);console.log(`Vui lòng restart lại server`);rl.close()});const connectDB=async()=>{try{await mongoose.connect("mongodb://127.0.0.1:27017/chat");console.log("Kết nối MongoDB thành công")}catch(err){console.error("Lỗi khi kết nối cơ sở dữ liệu:",err)}};setTimeout(connectDB,a);app.get("/",(req,res)=>{res.sendFile(__dirname+"/view/user.html")});app.get("/admin-chat",(req,res)=>{res.sendFile(__dirname+"/view/admin_chat.html")});app.get("/api/get_user",async(req,res)=>{const user_data=await User.find();res.status(200).send(user_data)});app.get("/api/get_mess_user",async(req,res)=>{console.log("GỌI API lấy tin nhắn");const userid=req.query.userid;const user_mess_data=await Message.find({$or:[{senderID:userid},{receiverID:userid,type:1}]});res.status(200).json(user_mess_data)});io.on("connection",socket=>{socket.on("admin_send_to_server",async msg=>{const vietnamTime=new Date((new Date).getTime()+7*60*60*1e3).toISOString();var data={senderID:msg.uID,senderName:msg.uName,receiverID:msg.receiverID,message:msg.message,timestamp:vietnamTime,type:1};console.log(data);const newMessageAdmin=new Message(data);try{await newMessageAdmin.save()}catch(err){console.log("Loi them vao db")}io.emit(`${msg.receiverID}`,data)});socket.on("client_send_to_server",async msg=>{const vietnamTime=new Date((new Date).getTime()+7*60*60*1e3).toISOString();adminID="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-";var data={senderID:msg.uID,senderName:msg.uName,receiverID:adminID,message:msg.message,timestamp:vietnamTime};try{const getUser=await User.findOne({userID:msg.uID});if(!getUser){var user={userID:msg.uID,userName:msg.uName,lastMessage:msg.message,status:"on"};const userModel=new User(user);await userModel.save();console.log("Thêm người dùng thành công")}else{await User.findOneAndUpdate({userID:msg.uID},{$set:{lastMessage:msg.message}})}}catch(err){console.log("Lỗi khi thêm user",err)}socket.emit("server_send_to_client",msg.message);io.emit("server_send_to_admin",data);const newMessage=new Message(data);try{await newMessage.save();console.log("Đã thêm tin nhắn")}catch(err){console.log("Lỗi khi thêm dữ liệu: ",err)}})});server.listen(3e3,()=>{});